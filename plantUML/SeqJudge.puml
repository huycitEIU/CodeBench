@startuml Run_Code_Flow_V3

actor User
participant "MainController" as CTRL
participant "BatchJudgeTask" as TASK
participant "JudgeSession" as SESSION
participant "JavaCompilerService" as COMP
participant "TempWorkspace" as WS
participant "JavaRunner" as RUN
participant "ProcessMemoryMonitor" as MEM
participant "FileIOService" as IO

User -> CTRL : Click "Run"
activate CTRL

' 1. Tạo Session & Task
CTRL -> SESSION : createSession(sourceCode, time, mem)
activate SESSION
SESSION --> CTRL : return new Session
deactivate SESSION

CTRL -> TASK : new BatchJudgeTask(session, rows, uiCallback)
activate TASK
CTRL -> TASK : thread.start()
deactivate CTRL
' Controller trả về ngay để UI không bị đơ

' 2. Bắt đầu chạy trong Background Thread
activate TASK
TASK -> TASK : Platform.runLater(Set status "Compiling")

TASK -> SESSION : compile()
activate SESSION
SESSION -> COMP : compile(workspace, code)
activate COMP

' --- [FIX] BƯỚC QUAN TRỌNG: GHI FILE SOURCE TRƯỚC ---
COMP -> WS : write("Solution.java", sourceCode)
activate WS
WS --> COMP : File created
deactivate WS
' ----------------------------------------------------

COMP -> COMP : Process("javac Solution.java")
COMP --> SESSION : Success
deactivate COMP
deactivate SESSION

' 3. Vòng lặp chấm bài
loop For each TestCase
    TASK -> TASK : Platform.runLater(Set status "Running...")

    TASK -> SESSION : runTestCase(testCase)
    activate SESSION

    ' 3.1 Runner chạy Process
    SESSION -> RUN : run(inputPath, sandbox)
    activate RUN

    ' Runner cấu hình redirect output vào file trong Workspace
    RUN -> RUN : ProcessBuilder.redirectOutput(stdout.txt)
    RUN -> RUN : ProcessBuilder.start()

    ' 3.2 Khởi động Monitor đo RAM
    create MEM
    RUN -> MEM : new ProcessMemoryMonitor(process)
    RUN -> MEM : start()
    activate MEM

    ' Process thực tế sẽ tự động ghi output vào file do OS quản lý
    note right of RUN
       Process đang chạy...
       (OS tự động ghi stdout -> stdout.txt)
    end note

    RUN -> RUN : waitFor(timeLimit)

    RUN -> MEM : stopMonitoring()
    MEM --> RUN : peakMemoryBytes
    deactivate MEM
    destroy MEM

    RUN --> SESSION : RunResult (exitCode, time, memory)
    deactivate RUN

    ' 3.3 So sánh kết quả
    SESSION -> IO : readString(stdout.txt)
    SESSION -> IO : readString(expected.txt)
    SESSION -> SESSION : Parser.normalize() & compare

    SESSION --> TASK : JudgeResult (PASSED/FAILED)
    deactivate SESSION

    ' 3.4 Cập nhật UI
    TASK -> TASK : Platform.runLater(updateRow & updateScore)
end

TASK -> TASK : Platform.runLater(Set status "Done")
deactivate TASK

@enduml