@startuml CodeBench_Architecture_Final

skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam packageStyle rectangle

' --- DOMAIN LAYER ---
package "Domain (Model)" {
    class TestCase <<record>> {
        + name(): String
        + inputPath(): Path
        + expectedOutputPath(): Path
    }

    class RunResult <<record>> {
        + isTimeout: boolean
        + exitCode: int
        + runTimeMs: long
        + memoryBytes: long
        + stdoutPath: Path
        + stderrPath: Path
    }

    class JudgeResult {
        - status: Verdict
        - runTimeMs: long
        - memoryBytes: long
        - actualOutputPath: Path
        - message: String
        __ Static Factories __
        + {static} fromExecution(...)
        + {static} fromError(...)
    }

    enum Verdict {
        PASSED("AC")
        FAILED("WA")
        TLE("TLE")
        RUNTIME_ERROR("RTE")
        COMPILE_ERROR("CE")
        SYSTEM_ERROR("SE")
    }
}

' --- UI LAYER ---
package "UI Layer" {
    class MainController {
        - txtTimeLimit: TextField
        - txtMemoryLimit: TextField
        - tblResultData: ObservableList
        + onRunClicked() : void
        note: Creates BatchJudgeTask\nto prevent UI freezing
    }

    class BatchJudgeTask <<Task<Void>>> {
        - session: JudgeSession
        - rows: List<TestResultRow>
        + call() : Void
        note: Updates UI via\nPlatform.runLater()
    }

    class TestResultRow {
        - originalTestCase: TestCase
        - status: StringProperty
        - runtime: StringProperty
        - memory: StringProperty
        + updateResult(status, time, mem, path)
    }

    class ViewHelper <<Utility>> {
        + {static} showDiffDialog(...)
        + {static} showError(...)
    }
}

' --- SERVICE LAYER ---
package "Service Layer" {
    class JudgeService {
        + createSession(code, time, mem): JudgeSession
    }

    class JudgeSession {
        - workspace: Workspace
        - sandbox: Sandbox
        - isCompiled: boolean
        + compile()
        + runTestCase(TestCase): JudgeResult
        + close()
    }

    class FileIOService {
        + readString(Path): String
        + readPreview(Path): String
    }

    class TestCaseImportService {
        + loadTestCasesFromFolder(File): List<TestCase>
    }
}

' --- INFRASTRUCTURE ---
package "Infrastructure" {
    interface Sandbox {
        + apply(ProcessBuilder)
    }

    class LocalSandbox implements Sandbox {
        - memoryLimitBytes: long
        + apply(ProcessBuilder)
        note: Injects -Xmx flag\nfor Java processes
    }

    class JavaRunner {
        + run(inputPath, Sandbox): RunResult
    }

    class ProcessMemoryMonitor <<Thread>> {
        - process: Process
        - peakMemory: long
        + run()
        + getPeakMemoryBytes(): long
        note: Polling process memory\nvia OS commands (ps/tasklist)
    }

    interface Workspace {
        + getRoot(): Path
        + close()
    }

    class TempWorkspace implements Workspace {
        + close()
        note: Auto-delete folder\non close
    }

    interface OutputParser {
        + normalize(String): String
    }

    class DefaultOutputParser implements OutputParser
    class JavaCompilerService
}

' --- RELATIONSHIPS ---

' UI -> Service / Domain
MainController ..> JudgeService : "Init"
MainController ..> BatchJudgeTask : "Starts"
MainController ..> TestCaseImportService : "Uses"
MainController ..> ViewHelper : "Uses"
BatchJudgeTask --> JudgeSession : "Controls"
BatchJudgeTask o-- TestResultRow : "Updates"
TestResultRow *-- TestCase

' Service -> Infrastructure / Domain
JudgeService *-- JudgeSession : "Creates Inner Class"
JudgeSession --> JavaCompilerService : "Uses"
JudgeSession --> JavaRunner : "Uses"
JudgeSession --> Workspace : "Manages"
JudgeSession --> Sandbox : "Uses"
JudgeSession --> OutputParser : "Uses"
JudgeSession ..> JudgeResult : "Produces"

' Infrastructure Internal
JavaRunner ..> ProcessMemoryMonitor : "Spawns"
JavaRunner ..> RunResult : "Returns"
LocalSandbox ..> Workspace : "Points to"

' Domain Connections
JudgeResult *-- Verdict
JudgeResult ..> RunResult : "Mapped from"

@enduml